# Синхронизация базы данных через Git

## Проблема

Ранее файлы базы данных (*.db) были исключены из Git через .gitignore, что приводило к несинхронизированным данным между локальной машиной и сайтом.

## Решение

Реализована система автоматической синхронизации данных через JSON файлы.

## Как это работает

### 1. Автоматическая синхронизация

- **Pre-commit hook**: Перед каждым коммитом данные автоматически экспортируются из базы данных в `archive_data.json`
- **Post-merge hook**: После каждого pull данные автоматически импортируются из `archive_data.json` в базу данных

### 2. Ручная синхронизация

```bash
# Экспорт данных из базы в JSON
python sync_data.py export

# Импорт данных из JSON в базу
python sync_data.py import
```

## Файлы системы

- `sync_data.py` - скрипт для ручной синхронизации
- `archive_data.json` - JSON файл с данными (синхронизируется через Git)
- `data/archive.db` - файл базы данных SQLite
- `.git/hooks/pre-commit` - хук для экспорта перед коммитом
- `.git/hooks/post-merge` - хук для импорта после pull

## Процесс работы

### При разработке локально:
1. Вносите изменения в базу данных через приложение
2. При коммите данные автоматически экспортируются в JSON
3. JSON файл попадает в Git и отправляется на сайт

### При развертывании на сайте:
1. После pull JSON файл обновляется
2. Данные автоматически импортируются в базу данных сайта
3. Сайт работает с актуальными данными

## Безопасность

⚠️ **Важно**: JSON файл содержит все данные архива. Убедитесь, что:
- Репозиторий приватный
- Нет чувствительных данных в JSON файле
- JSON файл не содержит паролей или секретных ключей

## Диагностика

### Проверить состояние синхронизации:

```bash
# Проверить наличие файлов
ls -la archive_data.json data/archive.db

# Проверить данные в базе
python -c "
from data_manager import DataManager
m = DataManager()
print('Элементов в БД:', len(m.load_elements()))
m.close()
"
```

### Ручная синхронизация при проблемах:

```bash
# Экспортировать текущие данные
python sync_data.py export

# Принудительно импортировать
python sync_data.py import
```

## Откат изменений

Если нужно вернуться к исключению базы данных из Git:

1. Удалить `data/archive.db` из Git:
   ```bash
   git rm --cached data/archive.db
   ```

2. Вернуть исключения в `.gitignore`:
   ```
   *.db
   data/*.db
   ```

3. Удалить git хуки:
   ```bash
   rm .git/hooks/pre-commit .git/hooks/post-merge
   ```

## Технические детали

- **Формат данных**: JSON с полной информацией о всех элементах и реестре
- **Версионирование**: JSON содержит метку времени и версию формата
- **Целостность**: При импорте данные полностью заменяют существующие
- **Производительность**: Экспорт/импорт оптимизированы для больших объемов данных